#!/usr/bin/env groovy

node {

    checkout scm
    def build = load("build.groovy")
    def buildlib = build.buildlib
    def commonlib = build.commonlib
    def slacklib = commonlib.slacklib
    commonlib.describeJob("build-sync", """
        <h2>Mirror latest 4.y images to nightlies</h2>
        <b>Timing</b>: usually automated. Human might use to revert or hand-advance nightly membership.

        This job gets the latest images from our candidate tags, syncs them to quay.io,
        and updates the imagestreams on api.ci which feed into nightlies on our
        release-controllers.

        build-sync runs a comprehensive set of checks validating the internal consistency
        of the proposed imagestream, and may halt the process accordingly. It can be considered
        the main artbiter.

        For more details see the <a href="https://github.com/openshift/aos-cd-jobs/blob/master/jobs/build/build-sync/README.md" target="_blank">README</a>
    """)

    // Please update README.md if modifying parameter names or semantics
    properties(
            [
                    disableResume(),
                    buildDiscarder(
                            logRotator(
                                    artifactDaysToKeepStr: '60',
                                    daysToKeepStr: '60',
                            )
                    ),
                    [
                            $class              : 'ParametersDefinitionProperty',
                            parameterDefinitions: [
                                    commonlib.suppressEmailParam(),
                                    commonlib.mockParam(),
                                    commonlib.ocpVersionParam('BUILD_VERSION', '4'),
                                    commonlib.doozerParam(),
                                    string(
                                        name: 'ASSEMBLY',
                                        description: 'The name of an assembly to sync.',
                                        defaultValue: "stream",
                                        trim: true,
                                    ),
                                    booleanParam(
                                            name        : 'PUBLISH',
                                            description : 'Publish release image(s) directly to registry.ci for testing',
                                            defaultValue: false,
                                    ),
                                    string(
                                        name: 'DOOZER_DATA_PATH',
                                        description: 'ocp-build-data fork to use (e.g. assembly definition in your own fork)',
                                        defaultValue: "https://github.com/openshift/ocp-build-data",
                                        trim: true,
                                    ),
                                    booleanParam(
                                            name        : 'DEBUG',
                                            description : 'Run "oc" commands with greater logging',
                                            defaultValue: false,
                                    ),
                                    booleanParam(
                                            name        : 'DRY_RUN',
                                            description : 'Run "oc" commands with the dry-run option set to true',
                                            defaultValue: false,
                                    ),
                                    booleanParam(
                                            name        : 'TRIGGER_NEW_NIGHTLY',
                                            description : 'Forces the release controller to re-run with existing images; no change will be made to payload images in the release. All other parameters will be ignored.',
                                            defaultValue: false,
                                    ),
                                    string(
                                            name        : 'IMAGES',
                                            description : '(Optional) Limited list of images to sync, for testing purposes',
                                            defaultValue: "",
                                            trim: true,
                                    ),
                                    string(
                                            name        : 'EXCLUDE_ARCHES',
                                            description : '(Optional) List of problem arch(es) NOT to sync (aarch64, ppc64le, s390x, x86_64)',
                                            defaultValue: "",
                                            trim: true,
                                    ),
                                    booleanParam(
                                            name        : 'EMERGENCY_IGNORE_ISSUES',
                                            description : 'Ignore all issues with constructing payload. Do not use without approval.',
                                            defaultValue: false,
                                    ),
                            ],
                    ]
            ]
    )  // Please update README.md if modifying parameter names or semantics

    commonlib.checkMock()
    buildlib.cleanWorkdir("${env.WORKSPACE}/MIRROR_working")
    echo("Initializing ${params.BUILD_VERSION} sync: #${currentBuild.number}")

    currentBuild.displayName = "${params.BUILD_VERSION} - ${ASSEMBLY}"
    if (params.DRY_RUN) {
        currentBuild.displayName += " [DRY_RUN]"
    }
    def arches = buildlib.branch_arches("openshift-${params.BUILD_VERSION}").toList()
    if ( params.EXCLUDE_ARCHES ) {
        excludeArches = commonlib.parseList(params.EXCLUDE_ARCHES)
        currentBuild.description += " [EXCLUDE ${excludeArches.join(', ')}]"
        if ( !arches.containsAll(excludeArches) )
            error("Trying to exclude arch ${excludeArches} not present in known arches ${arches}")
        arches.removeAll(excludeArches)
    }
    currentBuild.description += "Arches: ${arches.join(', ')}"

    imageList = commonlib.cleanCommaList(params.IMAGES)
    if ( imageList ) {
        echo("Only syncing specified images: ${imageList}")
        currentBuild.description += "<br>Images: ${imageList}"
        currentBuild.displayName += " [${imageList.split(',').size()} Image(s)]"
    }

    failCountFile = "${BUILD_VERSION}-assembly.${ASSEMBLY}.count"


    try {
        if (params.TRIGGER_NEW_NIGHTLY && params.ASSEMBLY == "stream" ) {
            if (params.DRY_RUN) {
                echo "Would have triggered new release cut in release controller."
            } else {
                def cmd = [
                    "artcd",
                    "-v",
                    "--working-dir=./artcd_working",
                    "--config", "./config/artcd.toml",
                    "imagestreams", "trigger",
                    "--version", params.BUILD_VERSION,
                ]
                echo "Will run ${cmd}"
                commonlib.shell(script: cmd.join(' '))
            }
            return
        }

        // // An incident where a bug in oc destroyed the content of a critical imagestream ocp:is/release uncovered the fact that this vital data was not being backed up by any process.
        // DPTP will be asked to backup etcd on this cluster, but ART should also begin backing up these imagestreams during normal operations as a first line of defense.
        // In the build-sync job, prior to updating the 4.x-art-latest imagestreams, a copy of all imagestreams in the various release controller namespaces should be performed.
        stage("backup imagestreams") {
          if (params.DRY_RUN) {
              echo "Would have triggered new release cut in release controller."
          } else {
              def cmd = [
                  "artcd",
                  "-v",
                  "--working-dir=.",
                  "--config", "./config/artcd.toml",
                  "imagesstreams",
                  "backup",
              ]
              echo "Will run ${cmd}"
              commonlib.shell(script: cmd.join(' '))
          }
        }

        // This stage is safe to run concurrently. Each build runs
        // these steps in its own directory.
        stage("update nightly imagestreams") {
          echo("Generating and applying imagestream updates")
          def cmd = [
              "artcd",
              "-v",
              "--working-dir=.",
              "--config", "./config/artcd.toml",
              "imagesstreams",
              "update",
              "--doozer_data_path", params.DOOZER_DATA_PATH,
              "--build_version", params.BUILD_VERSION,
              "--assembly", params.ASSEMBLY,
              "--working_dir", "${env.WORKSPACE}/MIRROR_working",
          ]
          if (imageList) {
            cmd += f"--imagelist ${imageList}"
          }
          if (params.EXCLUDE_ARCHES) {
            for(arch in excludeArches) {
              cmd += f"--exclude-arch ${arch}"
            }
          }
          if (params.DRY_RUN) {
            cmd += "--dry-run"
          }
          if (params.EMERGENCY_IGNORE_ISSUES) {
            cmd += "--emergency_ignore_issues"
          }
          if (params.PUBLISH) {
            cmd += "--publish"
          }
          if (params.DEBUG) {
            cmd += "--debug"
          }
          echo "Will run ${cmd}"
          commonlib.shell(script: cmd.join(' '))
        }

        // Successful buildsync, reset fail count
        writeFile file: failCountFile, text: "0"

    } catch (err) {
        failCount = 1
        if (fileExists(failCountFile)) {
            failCountStr = readFile(failCountFile).trim()
            if (failCountStr.isInteger()) {
                failCount = failCountStr.toInteger() + 1
            }
        }
        writeFile file: failCountFile, text: "${failCount}"

        if (failCount > 1) {
            msg = "@release-artists - pipeline has failed to assemble release payload for ${BUILD_VERSION} (assembly ${ASSEMBLY}) ${failCount} times."
            if (failCount % 2 == 0) {  // spam ourselves a little more often than forum-release
                slacklib.to(params.BUILD_VERSION).failure(msg)
            }
            if (assembly == "stream" && (failCount % 5 == 0)) {  // let forum-release know why no new builds
                slacklib.to("#forum-release").failure(msg)
            }
        }

        currentBuild.displayName += " [FAILURE]"
        commonlib.email(
                to: "aos-art-automation+failed-build-sync@redhat.com",
                from: "aos-art-automation@redhat.com",
                replyTo: "aos-team-art@redhat.com",
                subject: "Error during OCP ${params.BUILD_VERSION} build sync",
                body: """
There was an issue running build-sync for OCP ${params.BUILD_VERSION}:

    ${err}
""")
        throw (err)
    } finally {
        commonlib.safeArchiveArtifacts(build.artifacts)
        sh "rm -rf ${env.WORKSPACE}/doozer_working"  // do not use cleanWorkspace as this will remove failure count
        sh "rm -rf ${env.WORKSPACE}/MIRROR_working"
    }
}
